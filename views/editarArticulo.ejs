<!DOCTYPE html>
<html>
  <%- include('./partials/head.ejs') %>
  <body>
    <div class="container-fluid">
        <%- include('./partials/headerCRUD.ejs') %>
      <div class="contenido">
            <div class="container-fluid">
            <form method="POST" action="/crudIndex/edit/<%= articulo[0].id %>/?_method=PUT" enctype="application/x-www-form-urlencoded">
                <div class="row">
                    <div class="col-3">
                        
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-12">
                                <span>Editando el producto NÂ° <%= articulo[0].id %></span>
                                <input type="hidden" value="<%= articulo[0].id %>" id="id"><br><br>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <span>Nombre: </span><input type="text" name="name" id="name" value="<%= articulo[0].name %>" placeholder="Descripcion del producto"><br><br>
                                <span>Categorize el producto: </span>
                                <select name="category" id="category">
                                    <% for(categoria of categorias){%>
                                        <option value="<%= categoria.id %>"><%= categoria.name %></option>
                                    <% }%>
                                </select><b>-></b>
                                <select name="subcategory" id="subcategory">
                                    <% for(categoria of categorias){
                                        for(subcategoria of categoria.subcategories){%>
                                        <option value="<%= subcategoria.scid %>"><%= categoria.name+" "+subcategoria.name %></option>
                                    <% }
                                
                                    }%>
                                </select><br><br>
                                <span>Importe en pesos: </span>
                                <input type="number" name="price" id="price" value="<%= articulo[0].price %>" placeholder="$0.00"><br><br>
        
                                <span>Descuento en porcentaje: </span>
                                <input type="number" name="discount" id="discount" value="<%= articulo[0].discount %>" placeholder="%10"><br><br>
        
                                <span>No esta disponible para la venta: </span>
                                <input type="checkbox" name="discontinued_timestamp" id="discount_timestamp" <%= articulo[0].discontinued_timestamp ? "checked" : "" %> ><br><br>
        
                                <span>Producto de nueva temporada: </span>
                                <input type="checkbox" name="new_season" id="new_season" <%= articulo[0].new_season ? "checked" : "" %>><br><br>
        
                                <span>Es en oferta: </span>
                                <input type="checkbox" name="sale" id="sale" value="<%= articulo[0].sale %>" <%= articulo[0].new_season ? "checked" : "" %>><br><br>
                                <span>Caracteristicas: </span><br>
                                <textarea name="description" cols="30" rows="5" id="description"><%= articulo[0].description %></textarea><br><br>
                               
                                
                            </div>
                            <div class="col-6">
                                <script>
                                    var contador = 0;
                                    function agregarContenedor(){
                                        var objContenedor = document.getElementById("contenedor-imagenes");
                                        var nuevoContenedor = document.createElement('div');
                                        var nuevoColor = document.createElement('input');
                                        var nuevoInput = document.createElement('input');
                                        var nombreColor = document.createElement('input');
                                        nombreColor.type = 'text';
                                        nuevoColor.type = 'color';
                                        nuevoContenedor.className = "contenedor-color";
                                        nuevoContenedor.name= "grupoDeImagenes";
                                        nuevoColor.id = "colorNuevo"+(this.contador+1);
                                        nombreColor.id = "colorNuevo"+(this.contador+1);
                                        nuevoColor.name = "colorNuevo"+(this.contador+1);
                                        nombreColor.name = "colorNuevo"+(this.contador+1);
                                        nombreColor.placeholder = "Ej. Verde claro";
                                        nuevoInput.type = "file";
                                        nuevoInput.name="imagenNueva"+(this.contador+1);
                                        nuevoInput.id = "imagenNueva"+(this.contador+1);
                                        this.contador ++;
                                        nuevoInput.multiple = true;
                                        nuevoInput.addEventListener("change",function(){
                                            // Elimino las imagenes viejas
                                            var imagenesPrevias = '';
                                            imagenesPrevias = nuevoContenedor.getElementsByTagName('img');
                                            console.log("imagenesPrevias",imagenesPrevias);
                                            console.log("imagenesPrevias.length",imagenesPrevias.length);
                                            if(imagenesPrevias.length > 0){
                                                for(let i = 0; i <= imagenesPrevias.length ; i++){
                                                    console.log("valor de i:",i);
                                                    console.log("se borro el articulo",imagenesPrevias[i].name);
                                                    imagenesPrevias[i].remove();
                                                    if(i < imagenesPrevias.length){
                                                      i = i - 1;
                                                    }
                                                }
                                            }
                                            // Creo las nuevas imagenes
                                            for (var i = 0; i < nuevoInput.files.length; i++){
                                                var img = document.createElement("img");
                                                img.width = "65";
                                                img.height = "90";
                                                img.className = "img-thumbnail";
                                                img.name= nuevoInput.files[i].name;
                                                img.id = nuevoInput.name+i;
                                                img.addEventListener("click",function(){
                                                    eliminarme(this.id,false);
                                                });
                                                var imagenUrl = URL.createObjectURL(nuevoInput.files[i]);
                                                img.src = imagenUrl;
                                                nuevoContenedor.appendChild(img);
                                            }
                                        })
                                        var br = document.createElement("br");
                                        nuevoContenedor.appendChild(nombreColor);
                                        nuevoContenedor.appendChild(nuevoColor);
                                        nuevoContenedor.appendChild(br);
                                        nuevoContenedor.appendChild(nuevoInput);
                                        nuevoContenedor.appendChild(br);
                                        nuevoContenedor.appendChild(br);
                                        objContenedor.appendChild(nuevoContenedor);
                                        nuevoContenedor.appendChild(br);
                                    }
        
                                    // Elimina la imagen de la vista y crea un input para despues
                                    // borrarla desde el form
                                    function eliminarme(id,existente){
                                        if(existente){
                                            var imagen = document.getElementById(id);
                                            var contenedor = imagen.parentElement;
                                            var nuevoInputHidden = document.createElement("input");
                                            nuevoInputHidden.type = "hidden";
                                            nuevoInputHidden.value = JSON.stringify({
                                                id: contenedor.id, 
                                                imgName: imagen.src,
                                            });
                                            nuevoInputHidden.name = "imagenEliminada";
                                            contenedor.appendChild(nuevoInputHidden);
                                            imagen.remove();
                                        }else{
                                            // no se puede remover solo una imagen
                                            
                                        }
                                    }

                                    function updateColorHexa(id){
                                        var colores = document.getElementById(id);
                                        var colorElegido = colores.value;
                                        var color = document.getElementById('color'+id.replace('coloresExistentes',''));
                                        console.log(color);
                                        
                                        color.value = colorElegido;
                                       
                                    }
                                </script>
                                <div id="contenedor-imagenes">
                                <% for(item of infoextra){%>
                                    <div class="contenedor-color" id="<%= item.id %>">
                                        <select name="coloresExistentes" id="coloresExistentes<%= item.id %>" onChange="updateColorHexa(this.id)">
                                            <% for(color of colores){ %>
                                            <option value="<%= color.hexa%>"><%= color.name %></option>
                                            <% if(color.id == item.color){ var color1 = color.hexa }%>
                                            <% } %>
                                        </select>
                                        <input type="color" disabled value="<%= color1 %>>" id="color<%= item.id %>">
                                        <input type="file" name="imgColorExistente" multiple><br>
                                    <% for(let i = 0; i < item.images.length; i++){ %> 
                                        <img src="/images/articulos/<%= item.images[i] %>" id="<%= item.id+'-'+i %>" alt="..." class="img-thumbnail" width="65px" height="90px" onclick="eliminarme(this.id,true)">
                                    <% } %>
                                    </div><br>
                                <% }%>
                                </div>
                                <div>
                                    
                                    <a href="#" onclick="agregarContenedor()">Agregar grupo de imagenes</a>
                                </div>

                            </div>

                        </div>
                        <input type="submit" value="Guardar cambios">
                    </div>
                    <div class="col-3">

                    </div>
                </div>
          
                
            </form>
        </div>
        <%- include('./partials/scriptBootstrap.ejs') %>
      </div>
    </div>
  </body>

</html>
