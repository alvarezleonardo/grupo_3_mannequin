<script>
    function seleccionarColor(id, rutaImagen, color) {
        document.getElementById('foto' + id).src = rutaImagen;
        document.getElementById('elegido' + id).value = color;
        document.getElementById('nombreElegido' + id).innerHTML = "Color elegido: " + color;
    }
    function favoritos(id) {
        var objFavorito = document.getElementById('favorito' + id);
        if (objFavorito.value == 1) {
            objFavorito.className = "heart-carrito far fa-heart";
            objFavorito.value = 0;
        } else {
            objFavorito.className = "heart-carrito fas fa-heart";
            objFavorito.value = 1;
        }
    }

</script>

<div class="card-group">
    <% if(products.length > 0){ %>
        <% var grupoAnterior = 0;%>
        <% var articuloCombinado = 0; %>
        <% for(let i = 0; i<products.length; i++) { %>
            <% if(products[i].group != grupoAnterior){%>
                <div class="product-box" id="<%=products[i].idproducts%>">
                    <div class="card" style="width: 18rem;">
                        <div class="cardImgContainer">
                            <% if(typeof products[i].images[0] != 'undefined') { %>
                                <img class="card-img-top" src="/images/articulos/<%= products[i].images[0].file_name %>" alt=""
                                id="foto<%= products[i].idproducts%>" onclick="window.location.href='/detalleProducto/<%= products[i].idproducts%>'" >
                            <% }else{ %>
                                <img class="card-img-top" src="/images/articulos/no_img.png" alt=""
                                    id="foto<%= products[i].idproducts%>"  onclick="window.location.href='/detalleProducto/<%= products[i].idproducts%>'" width="220" height="292"> 
                            <% }%>
                            <div class="container-bag">
                                <button class="addBag" id="addBag<%=products[i].idproducts%>">Add to basket</button>
                                <script>
                                    var botonBag = document.getElementById("addBag<%=products[i].idproducts%>")
                                    botonBag.addEventListener("click",function(){
                                        console.log("este producto <%=products[i].idproducts%>");
                                        fetch("http://localhost:3000/api/products/cart",{
                                                method: 'POST',
                                                body: JSON.stringify({artId: <%=products[i].idproducts%>, userId: <%= user.idusers %>}),
                                                headers: {
                                                'Content-Type': 'application/json'
                                                }
                                        })
                                    })
                                </script>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title" id="productname<%=products[i].idproducts%>"><%= products[i].name %> </h5>
                            <span class="precio-item-carrito" id="productprice<%=products[i].idproducts%>">$ <%= thousandGenerator(products[i].price) %></span>
                            <div class="barra-iconos-cat">
                                <div class="selector-color-carrito">
                                    <script>
                                        var articuloPrincipal = document.getElementById(<%=products[i].idproducts%>)
                                        var coloresPrincipal = articuloPrincipal.querySelector(".selector-color-carrito")
                                        var botonColor = document.createElement("button");
                                        botonColor.className = "boton-slector-color";
                                        botonColor.style.backgroundColor = "<%=products[i].color%>"
                                        botonColor.id = "botoncolor<%=products[i].idproducts%>"
                                        botonColor.addEventListener("click",function(){
                                            /* Actualizar imagen */
                                            <% if(typeof products[i].images[0] != 'undefined') { %>
                                                var imagenProducto = document.getElementById("foto<%= products[i].idproducts%>");
                                                imagenProducto.src = "/images/articulos/<%= products[i].images[0].file_name %>"
                                                imagenProducto.onclick = function(){ return window.location.assign('/detalleProducto/<%= products[i].idproducts%>')}
                                                <% }else{ %>
                                                    document.getElementById("foto<%= products[i].idproducts%>").src = "/images/articulos/no_img.png"           
                                                <% }%>
                                            /* Actualizar nombre */
                                            var nombre = document.getElementById("productname<%=products[i].idproducts %>");
                                            nombre.innerHTML = "<%= products[i].name %>"
                                            
                                           
                                            
                                            /* Actualizar precio */
                                            var precio = document.getElementById("productprice<%=products[i].idproducts %>");
                                            precio.innerHTML = "$ <%= thousandGenerator(products[i].price) %>"
                                            
                                            /* Actualizar product-box*/
                                            var elementoaa = this.parentElement.parentElement.parentElement.parentElement.parentElement;
                                            
                                             /* Actualizar basket button */
                                            var addBag = document.getElementById("addBag"+elementoaa.id);
                                            console.log("boton ",addBag)
                                            addBag.id = "addBag<%= products[i].idproducts%>"

                                            elementoaa.id = <%= products[i].idproducts%>

                                            /* Actualizar talles */
                                            var parametro = <%= products[i].idproducts%>;
                                            getSizes(parametro)
                                        })
                                        coloresPrincipal.appendChild(botonColor);
                                    </script>
                                </div>
                                <div class="botones-fav-del-carrito">
                                    <div class="boton-favorito-carrito">
                                        <button class="heart-carrito far fa-heart" value="0"
                                            onclick="favoritos('<%=products[i].idproducts%>')"
                                            id="favorito<%=products[i].idproducts%>"></button>
                                    </div>
                                </div>

                                </script>
                                <div id="talles<%=products[i].idproducts%>" class="talles">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% articuloCombinado = products[i].idproducts %>
            <%}else{%>
                <script>
                    var articulo = document.getElementById(<%=articuloCombinado%>)
                    /* Contenedor de colores*/
                    var colores = articulo.querySelector(".selector-color-carrito")
                    /* Boton de color */
                    var botonColor = document.createElement("button");
                    botonColor.className = "boton-slector-color";
                    botonColor.style.backgroundColor = "<%=products[i].color%>"
                    botonColor.id = "botoncolor<%=products[i].idproducts%>"
                    botonColor.addEventListener("click",function(){
                        /* Actualizar imagen */
                        <% if(typeof products[i].images[0] != 'undefined') { %>
                                var imagenProducto = document.getElementById("foto<%= articuloCombinado%>");
                                imagenProducto.src = "/images/articulos/<%= products[i].images[0].file_name %>";
                                imagenProducto.onclick = function(){window.location.assign('/detalleProducto/<%= products[i].idproducts%>')};
                            <% }else{ %>
                                var imagenProducto =document.getElementById("foto<%= articuloCombinado%>");
                                imagenProducto.src = "/images/articulos/no_img.png";
                                imagenProducto.onclick = function(){window.location.assign('/detalleProducto/<%= products[i].idproducts%>')};      
                            <% }%>
                        /* Actualizar nombre */
                        var nombre = document.getElementById("productname<%=articuloCombinado %>");
                        nombre.innerHTML = "<%= products[i].name %>";
                        
                        /* Actualizar precio */
                        var precio = document.getElementById("productprice<%=articuloCombinado %>");
                        precio.innerHTML = "$ <%= thousandGenerator(products[i].price) %>";

                        /* Actualizar product-box*/
                        var elementoaa = this.parentElement.parentElement.parentElement.parentElement.parentElement;

                        /* Actualizar basket button */
                        var addBag = document.getElementById("addBag"+elementoaa.id);
                        console.log("boton ",addBag)
                        addBag.id = "addBag<%= products[i].idproducts%>"
                        addBag.addEventListener("click",function(){
                            console.log("este producto <%=products[i].idproducts%>");
                            fetch("http://localhost:3000/api/products/cart",{
                                    method: 'POST',
                                    body: JSON.stringify({artId: <%=products[i].idproducts%>, userId: <%= user.idusers %>}),
                                    headers: {
                                    'Content-Type': 'application/json'
                                    }
                            })
                        })
                        elementoaa.id = <%= products[i].idproducts%>
                        
                        /* Actualizar talles */
                        var parametro = <%= products[i].idproducts%>;
                        getSizes(parametro)
                    })
                    colores.appendChild(botonColor);
                </script>
            <%}%>
            <% grupoAnterior = products[i].group %>
            
        <%}%>
    <% }else{ %>
        <div class="product-box">
            <img src="/images/otras/not_found.jpg" alt="">
            <br>
            <h2>Tu búsqueda no arrojó resultados.</h2>
            <h3><a href="/categories/?">Volver</a></h3>
    <% }%>

    <script>
        function getSizes(id){
            if(id == null){
                id = ".product-box"
                var productos = document.querySelectorAll(id);
            }else{
                console.log(id)
                var produ = document.getElementById(id);
                var productos = [produ]
            }

            productos.forEach(function(element){
                var id = element.id;
                var t = element.querySelector('.talles');
                t.innerHTML = "";
                var d = document.createElement('div');
                var url = "/api/products/productsizes/"+id;
                console.log("URL",url)
                fetch(url)
                .then(function(respuesta){
                    return respuesta.json()
                })
                .then(function(info){
                    info[0].sizes.forEach(function(talle){
                        var b = document.createElement('button');
                        b.innerHTML = talle.name;
                        b.id = id+"-"+talle.idsizes;
                        b.className = "boton-talle";
                        b.style.marginRight = "3px";
                        b.addEventListener("click",function(){
                            if(this.className == "boton-talle"){
                                /* restauro el anterior*/
                                var talleAnterior = d.querySelector(".boton-talle-elegido");
                                if(talleAnterior){
                                    talleAnterior.className = "boton-talle"
                                }
                                /* Actualizo el elegido*/
                                this.className = "boton-talle-elegido";
                            }else{
                                this.className = "boton-talle"
                            }
                        })
                        d.appendChild(b)
                    })
                    t.appendChild(d);
                });
            })
        }

        getSizes();
        // var talles = producto.querySelector(".talles")

        //     idproduct = element.children[0].value;
        //     divBotones = element.children[1];
        //     var tall = [{size:0, name: 'M'},{size:1, name:'L'}];
        //     tall.forEach(function(element){
        //         var boton1 = document.createElement("button");
        //         boton1.className = "boton-talle";
        //         boton1.innerHTML = element.name;
        //         boton1.value = element.size;
        //         divBotones.appendChild(boton1);
        //     })
    </script>
</div>